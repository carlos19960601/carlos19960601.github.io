<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>RocketMQ Broker启动流程 | PaperMod</title>
<meta name="keywords" content="RocketMQ, 消息队列">
<meta name="description" content="Broker的启动类是BrokerStartup
public static void main(String[] args) {
    start(createBrokerController(args));
}
和Namesrv启动差不多，首先创建一个BrokerController，然后调用start()方法">
<meta name="author" content="">
<link rel="canonical" href="//localhost:1313/posts/rocketmq-broker%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="//localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="//localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="//localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="//localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="//localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="//localhost:1313/posts/rocketmq-broker%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="//localhost:1313/" accesskey="h" title="PaperMod (Alt + H)">PaperMod</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      RocketMQ Broker启动流程
    </h1>
    <div class="post-meta"><span title='2020-11-27 22:38:54 +0800 CST'>November 27, 2020</span>

</div>
  </header> 
  <div class="post-content"><p>Broker的启动类是<code>BrokerStartup</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>    start(createBrokerController(args));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>和Namesrv启动差不多，首先创建一个<code>BrokerController</code>，然后调用start()方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> BrokerController <span style="color:#a6e22e">createBrokerController</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 省略了从环境变量中读取配置设置到NettySystemConfig</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 和Namesrv差不多，使用命令行工具包commons-cli根据命令行参数解析成CommandLine对象</span>
</span></span><span style="display:flex;"><span>        Options options <span style="color:#f92672">=</span> ServerUtil.<span style="color:#a6e22e">buildCommandlineOptions</span>(<span style="color:#66d9ef">new</span> Options());
</span></span><span style="display:flex;"><span>        commandLine <span style="color:#f92672">=</span> ServerUtil.<span style="color:#a6e22e">parseCmdLine</span>(<span style="color:#e6db74">&#34;mqbroker&#34;</span>, args, buildCommandlineOptions(options),
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> PosixParser());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> commandLine) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span>1);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 这里有3个配置类，相比Namesrv只有NamesrvConfig，NettyServerConfig2个配置类</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> BrokerConfig brokerConfig <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BrokerConfig();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> NettyServerConfig nettyServerConfig <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NettyServerConfig();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> NettyClientConfig nettyClientConfig <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NettyClientConfig();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// TLS相关 </span>
</span></span><span style="display:flex;"><span>        nettyClientConfig.<span style="color:#a6e22e">setUseTLS</span>(Boolean.<span style="color:#a6e22e">parseBoolean</span>(System.<span style="color:#a6e22e">getProperty</span>(TLS_ENABLE,
</span></span><span style="display:flex;"><span>            String.<span style="color:#a6e22e">valueOf</span>(TlsSystemConfig.<span style="color:#a6e22e">tlsMode</span> <span style="color:#f92672">==</span> TlsMode.<span style="color:#a6e22e">ENFORCING</span>))));
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Broker监听端口10911</span>
</span></span><span style="display:flex;"><span>        nettyServerConfig.<span style="color:#a6e22e">setListenPort</span>(10911);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> MessageStoreConfig messageStoreConfig <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MessageStoreConfig();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// BrokerRole如果是SLAVE设置accessMessageInMemoryMaxRatio，MessageStoreConfig中有一堆关于message相关的配置，后面总结配置的时候一起写</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (BrokerRole.<span style="color:#a6e22e">SLAVE</span> <span style="color:#f92672">==</span> messageStoreConfig.<span style="color:#a6e22e">getBrokerRole</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> ratio <span style="color:#f92672">=</span> messageStoreConfig.<span style="color:#a6e22e">getAccessMessageInMemoryMaxRatio</span>() <span style="color:#f92672">-</span> 10;
</span></span><span style="display:flex;"><span>            messageStoreConfig.<span style="color:#a6e22e">setAccessMessageInMemoryMaxRatio</span>(ratio);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 注意了，-c 选项又来了，在Namesrv启动时 -c 指定的配置文件被反复蹂躏，那么在Broker启动的时候，她的命运是否还是如此呢？</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (commandLine.<span style="color:#a6e22e">hasOption</span>(<span style="color:#e6db74">&#39;c&#39;</span>)) {
</span></span><span style="display:flex;"><span>            String file <span style="color:#f92672">=</span> commandLine.<span style="color:#a6e22e">getOptionValue</span>(<span style="color:#e6db74">&#39;c&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (file <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                configFile <span style="color:#f92672">=</span> file;
</span></span><span style="display:flex;"><span>                InputStream in <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedInputStream(<span style="color:#66d9ef">new</span> FileInputStream(file));
</span></span><span style="display:flex;"><span>                properties <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Properties();
</span></span><span style="display:flex;"><span>                properties.<span style="color:#a6e22e">load</span>(in);
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 从配置文件中读取了2个配置设置到了系统属性中</span>
</span></span><span style="display:flex;"><span>                properties2SystemEnv(properties);
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 下面就很熟悉了，将配置文件中的配置拆分到BrokerConfig,NettyClientConfig,NettyServerConfig,MessageStoreConfig</span>
</span></span><span style="display:flex;"><span>                MixAll.<span style="color:#a6e22e">properties2Object</span>(properties, brokerConfig);
</span></span><span style="display:flex;"><span>                MixAll.<span style="color:#a6e22e">properties2Object</span>(properties, nettyServerConfig);
</span></span><span style="display:flex;"><span>                MixAll.<span style="color:#a6e22e">properties2Object</span>(properties, nettyClientConfig);
</span></span><span style="display:flex;"><span>                MixAll.<span style="color:#a6e22e">properties2Object</span>(properties, messageStoreConfig);
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 记录配置文件</span>
</span></span><span style="display:flex;"><span>                BrokerPathConfigHelper.<span style="color:#a6e22e">setBrokerConfigPath</span>(file);
</span></span><span style="display:flex;"><span>                in.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 命令行中指定的配置设置到BrokerConfig</span>
</span></span><span style="display:flex;"><span>        MixAll.<span style="color:#a6e22e">properties2Object</span>(ServerUtil.<span style="color:#a6e22e">commandLine2Properties</span>(commandLine), brokerConfig);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 检查rocketmqHome是否指定，这里和Namesrv差不多</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 在BrokerConfig中，可以看到使用系统属性rocketmq.home.dir，环境变量ROCKETMQ_HOME和前面的-c指定的配置文件设置RocketMQHome</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 在mqnamesrv启动脚本中会自定探测RockerMQ并export ROCKETMQ_HOME</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> brokerConfig.<span style="color:#a6e22e">getRocketmqHome</span>()) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Please set the %s variable in your environment to match the location of the RocketMQ installation&#34;</span>, MixAll.<span style="color:#a6e22e">ROCKETMQ_HOME_ENV</span>);
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span>2);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 检查配置的NamesrvAddr格式是否正确，检查方式就是根据Addr能够构造出InetSocketAddress对象</span>
</span></span><span style="display:flex;"><span>        String namesrvAddr <span style="color:#f92672">=</span> brokerConfig.<span style="color:#a6e22e">getNamesrvAddr</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> namesrvAddr) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                String<span style="color:#f92672">[]</span> addrArray <span style="color:#f92672">=</span> namesrvAddr.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;;&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> (String addr : addrArray) {
</span></span><span style="display:flex;"><span>                    RemotingUtil.<span style="color:#a6e22e">string2SocketAddress</span>(addr);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">printf</span>(
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;The Name Server Address[%s] illegal, please set it as follows, \&#34;127.0.0.1:9876;192.168.0.1:9876\&#34;%n&#34;</span>,
</span></span><span style="display:flex;"><span>                    namesrvAddr);
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span>3);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 根据BrokerRole设置BrokerId，不过这里的BrokerRole都没有赋值，都是默认值ASYNC_MASTER</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> (messageStoreConfig.<span style="color:#a6e22e">getBrokerRole</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> ASYNC_MASTER:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> SYNC_MASTER:
</span></span><span style="display:flex;"><span>                brokerConfig.<span style="color:#a6e22e">setBrokerId</span>(MixAll.<span style="color:#a6e22e">MASTER_ID</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> SLAVE:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (brokerConfig.<span style="color:#a6e22e">getBrokerId</span>() <span style="color:#f92672">&lt;=</span> 0) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Slave&#39;s brokerId must be &gt; 0&#34;</span>);
</span></span><span style="display:flex;"><span>                    System.<span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span>3);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 又来一个端口</span>
</span></span><span style="display:flex;"><span>        messageStoreConfig.<span style="color:#a6e22e">setHaListenPort</span>(nettyServerConfig.<span style="color:#a6e22e">getListenPort</span>() <span style="color:#f92672">+</span> 1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 加载logback，根据命令行选项-p和-m在控制台打印打印配置信息</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (commandLine.<span style="color:#a6e22e">hasOption</span>(<span style="color:#e6db74">&#39;p&#39;</span>)) {
</span></span><span style="display:flex;"><span>            InternalLogger console <span style="color:#f92672">=</span> InternalLoggerFactory.<span style="color:#a6e22e">getLogger</span>(LoggerName.<span style="color:#a6e22e">BROKER_CONSOLE_NAME</span>);
</span></span><span style="display:flex;"><span>            MixAll.<span style="color:#a6e22e">printObjectProperties</span>(console, brokerConfig);
</span></span><span style="display:flex;"><span>            MixAll.<span style="color:#a6e22e">printObjectProperties</span>(console, nettyServerConfig);
</span></span><span style="display:flex;"><span>            MixAll.<span style="color:#a6e22e">printObjectProperties</span>(console, nettyClientConfig);
</span></span><span style="display:flex;"><span>            MixAll.<span style="color:#a6e22e">printObjectProperties</span>(console, messageStoreConfig);
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">exit</span>(0);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (commandLine.<span style="color:#a6e22e">hasOption</span>(<span style="color:#e6db74">&#39;m&#39;</span>)) {
</span></span><span style="display:flex;"><span>            InternalLogger console <span style="color:#f92672">=</span> InternalLoggerFactory.<span style="color:#a6e22e">getLogger</span>(LoggerName.<span style="color:#a6e22e">BROKER_CONSOLE_NAME</span>);
</span></span><span style="display:flex;"><span>            MixAll.<span style="color:#a6e22e">printObjectProperties</span>(console, brokerConfig, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>            MixAll.<span style="color:#a6e22e">printObjectProperties</span>(console, nettyServerConfig, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>            MixAll.<span style="color:#a6e22e">printObjectProperties</span>(console, nettyClientConfig, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>            MixAll.<span style="color:#a6e22e">printObjectProperties</span>(console, messageStoreConfig, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">exit</span>(0);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 还是打印配置，只是打印在logback配置的文件中</span>
</span></span><span style="display:flex;"><span>        log <span style="color:#f92672">=</span> InternalLoggerFactory.<span style="color:#a6e22e">getLogger</span>(LoggerName.<span style="color:#a6e22e">BROKER_LOGGER_NAME</span>);
</span></span><span style="display:flex;"><span>        MixAll.<span style="color:#a6e22e">printObjectProperties</span>(log, brokerConfig);
</span></span><span style="display:flex;"><span>        MixAll.<span style="color:#a6e22e">printObjectProperties</span>(log, nettyServerConfig);
</span></span><span style="display:flex;"><span>        MixAll.<span style="color:#a6e22e">printObjectProperties</span>(log, nettyClientConfig);
</span></span><span style="display:flex;"><span>        MixAll.<span style="color:#a6e22e">printObjectProperties</span>(log, messageStoreConfig);
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// BrokerController终于初始化了</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> BrokerController controller <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BrokerController(
</span></span><span style="display:flex;"><span>            brokerConfig,
</span></span><span style="display:flex;"><span>            nettyServerConfig,
</span></span><span style="display:flex;"><span>            nettyClientConfig,
</span></span><span style="display:flex;"><span>            messageStoreConfig);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 仍然在蹂躏可怜的配置文件</span>
</span></span><span style="display:flex;"><span>        controller.<span style="color:#a6e22e">getConfiguration</span>().<span style="color:#a6e22e">registerConfig</span>(properties);
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 这里直接调用了initialize()方法</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> initResult <span style="color:#f92672">=</span> controller.<span style="color:#a6e22e">initialize</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>initResult) {
</span></span><span style="display:flex;"><span>            controller.<span style="color:#a6e22e">shutdown</span>();
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span>3);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// shutdown的钩子</span>
</span></span><span style="display:flex;"><span>        Runtime.<span style="color:#a6e22e">getRuntime</span>().<span style="color:#a6e22e">addShutdownHook</span>(<span style="color:#66d9ef">new</span> Thread(<span style="color:#66d9ef">new</span> Runnable() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">boolean</span> hasShutdown <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">private</span> AtomicInteger shutdownTimes <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicInteger(0);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">synchronized</span> (<span style="color:#66d9ef">this</span>) {
</span></span><span style="display:flex;"><span>                    log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Shutdown hook was invoked, {}&#34;</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">shutdownTimes</span>.<span style="color:#a6e22e">incrementAndGet</span>());
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">hasShutdown</span>) {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">hasShutdown</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">long</span> beginTime <span style="color:#f92672">=</span> System.<span style="color:#a6e22e">currentTimeMillis</span>();
</span></span><span style="display:flex;"><span>                        controller.<span style="color:#a6e22e">shutdown</span>();
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">long</span> consumingTimeTotal <span style="color:#f92672">=</span> System.<span style="color:#a6e22e">currentTimeMillis</span>() <span style="color:#f92672">-</span> beginTime;
</span></span><span style="display:flex;"><span>                        log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Shutdown hook over, consuming total time(ms): {}&#34;</span>, consumingTimeTotal);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }, <span style="color:#e6db74">&#34;ShutdownHook&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> controller;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (Throwable e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span>1);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> BrokerController <span style="color:#a6e22e">start</span>(BrokerController controller) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        controller.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 省略了打印日志      </span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> controller;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (Throwable e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span>1);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到，Broker和Namesrv的启动都差不多，首先根据命令的选项和配置初始化一些配置类，然后用这些配置类创建一个Controller，Controller根据配置在initialize()方法中初始化一些信息，然后在start()中才真正的启动服务监听端口</p>
<p>不同点呢，就是Broker比Namesrv配置类多，逻辑可能就相对更加复杂一点，不用怕，我们慢慢啃</p>
<p>扯回来，启动主要逻辑都在BrokerController.initialize()和BrokerController.start()方法中</p>
<p>首先看看BrokerController中初始化了啥东西，WTF，咋这么多东西，先不管了，就认为初始化了很多东西</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">BrokerController</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> BrokerConfig brokerConfig,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> NettyServerConfig nettyServerConfig,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> NettyClientConfig nettyClientConfig,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> MessageStoreConfig messageStoreConfig
</span></span><span style="display:flex;"><span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span> <span style="color:#f92672">=</span> brokerConfig;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">nettyServerConfig</span> <span style="color:#f92672">=</span> nettyServerConfig;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">nettyClientConfig</span> <span style="color:#f92672">=</span> nettyClientConfig;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStoreConfig</span> <span style="color:#f92672">=</span> messageStoreConfig;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerOffsetManager</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsumerOffsetManager(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">topicConfigManager</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TopicConfigManager(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pullMessageProcessor</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PullMessageProcessor(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pullRequestHoldService</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PullRequestHoldService(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageArrivingListener</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NotifyMessageArrivingListener(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pullRequestHoldService</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerIdsChangeListener</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DefaultConsumerIdsChangeListener(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerManager</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsumerManager(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerIdsChangeListener</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerFilterManager</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsumerFilterManager(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">producerManager</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProducerManager();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientHousekeepingService</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClientHousekeepingService(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">broker2Client</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Broker2Client(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">subscriptionGroupManager</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SubscriptionGroupManager(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerOuterAPI</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BrokerOuterAPI(nettyClientConfig);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">filterServerManager</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FilterServerManager(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">slaveSynchronize</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SlaveSynchronize(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sendThreadPoolQueue</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedBlockingQueue<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>.<span style="color:#a6e22e">getSendThreadPoolQueueCapacity</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pullThreadPoolQueue</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedBlockingQueue<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>.<span style="color:#a6e22e">getPullThreadPoolQueueCapacity</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">queryThreadPoolQueue</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedBlockingQueue<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>.<span style="color:#a6e22e">getQueryThreadPoolQueueCapacity</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientManagerThreadPoolQueue</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedBlockingQueue<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>.<span style="color:#a6e22e">getClientManagerThreadPoolQueueCapacity</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerManagerThreadPoolQueue</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedBlockingQueue<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>.<span style="color:#a6e22e">getConsumerManagerThreadPoolQueueCapacity</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">heartbeatThreadPoolQueue</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedBlockingQueue<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>.<span style="color:#a6e22e">getHeartbeatThreadPoolQueueCapacity</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">endTransactionThreadPoolQueue</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedBlockingQueue<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>.<span style="color:#a6e22e">getEndTransactionPoolQueueCapacity</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerStatsManager</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BrokerStatsManager(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>.<span style="color:#a6e22e">getBrokerClusterName</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">setStoreHost</span>(<span style="color:#66d9ef">new</span> InetSocketAddress(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getBrokerConfig</span>().<span style="color:#a6e22e">getBrokerIP1</span>(), <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getNettyServerConfig</span>().<span style="color:#a6e22e">getListenPort</span>()));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerFastFailure</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BrokerFastFailure(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">configuration</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Configuration(
</span></span><span style="display:flex;"><span>        log,
</span></span><span style="display:flex;"><span>        BrokerPathConfigHelper.<span style="color:#a6e22e">getBrokerConfigPath</span>(),
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">nettyServerConfig</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">nettyClientConfig</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStoreConfig</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>接着看initialize()方法，我去这也不少啊，不过还是得一点一点啃</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">initialize</span>() <span style="color:#66d9ef">throws</span> CloneNotSupportedException {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 初始化4个Manager，从名字可以看出这4个Manager的指责</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> result <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">topicConfigManager</span>.<span style="color:#a6e22e">load</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> result <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerOffsetManager</span>.<span style="color:#a6e22e">load</span>();
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> result <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">subscriptionGroupManager</span>.<span style="color:#a6e22e">load</span>();
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> result <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerFilterManager</span>.<span style="color:#a6e22e">load</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果前面4个manager的配置加载成功了，会初始化一个MessageStore，并且用MessageStorePluginContext对MessageStore进行包装，具体初始化了哪些东西我现在也不知道，我们先看整个启动，以后再详细看每个小组件的功能，这里只需要知道初始化了一个MessageStore，这个MessageStore和Broker存储消息是有关系的</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (result) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStore</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> DefaultMessageStore(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStoreConfig</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerStatsManager</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageArrivingListener</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (messageStoreConfig.<span style="color:#a6e22e">isEnableDLegerCommitLog</span>()) {
</span></span><span style="display:flex;"><span>                DLedgerRoleChangeHandler roleChangeHandler <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DLedgerRoleChangeHandler(<span style="color:#66d9ef">this</span>, (DefaultMessageStore) messageStore);
</span></span><span style="display:flex;"><span>                ((DLedgerCommitLog)((DefaultMessageStore) messageStore).<span style="color:#a6e22e">getCommitLog</span>()).<span style="color:#a6e22e">getdLedgerServer</span>().<span style="color:#a6e22e">getdLedgerLeaderElector</span>().<span style="color:#a6e22e">addRoleChangeHandler</span>(roleChangeHandler);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerStats</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BrokerStats((DefaultMessageStore) <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStore</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//load plugin</span>
</span></span><span style="display:flex;"><span>            MessageStorePluginContext context <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MessageStorePluginContext(messageStoreConfig, brokerStatsManager, messageArrivingListener, brokerConfig);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStore</span> <span style="color:#f92672">=</span> MessageStoreFactory.<span style="color:#a6e22e">build</span>(context, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStore</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStore</span>.<span style="color:#a6e22e">getDispatcherList</span>().<span style="color:#a6e22e">addFirst</span>(<span style="color:#66d9ef">new</span> CommitLogDispatcherCalcBitMap(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerFilterManager</span>));
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            result <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Failed to initialize&#34;</span>, e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果配置和MessageStore都load成功了，才继续进行</span>
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> result <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStore</span>.<span style="color:#a6e22e">load</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (result) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 初始化Netty了</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NettyRemotingServer(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">nettyServerConfig</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientHousekeepingService</span>);
</span></span><span style="display:flex;"><span>        NettyServerConfig fastConfig <span style="color:#f92672">=</span> (NettyServerConfig) <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">nettyServerConfig</span>.<span style="color:#a6e22e">clone</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 又出现了一个端口</span>
</span></span><span style="display:flex;"><span>        fastConfig.<span style="color:#a6e22e">setListenPort</span>(nettyServerConfig.<span style="color:#a6e22e">getListenPort</span>() <span style="color:#f92672">-</span> 2);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 有起来一个Netty？</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NettyRemotingServer(fastConfig, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientHousekeepingService</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 初始化了一堆线程池</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sendMessageExecutor</span> <span style="color:#f92672">=</span> ...;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pullMessageExecutor</span> <span style="color:#f92672">=</span> ...;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">queryMessageExecutor</span> <span style="color:#f92672">=</span> ...;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientManageExecutor</span> <span style="color:#f92672">=</span>...;
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">heartbeatExecutor</span> <span style="color:#f92672">=</span> ...;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">endTransactionExecutor</span> <span style="color:#f92672">=</span> ...;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerManageExecutor</span> <span style="color:#f92672">=</span> ...;
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 注册处理器，这个我们可以详细看一下</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">registerProcessor</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 这里启动一些周期执行任务</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">scheduledExecutorService</span>.<span style="color:#a6e22e">scheduleAtFixedRate</span>(...);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 更新Broker中Namesrv的地址列表</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>.<span style="color:#a6e22e">getNamesrvAddr</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerOuterAPI</span>.<span style="color:#a6e22e">updateNameServerAddressList</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>.<span style="color:#a6e22e">getNamesrvAddr</span>());
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Set user specified name server address: {}&#34;</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>.<span style="color:#a6e22e">getNamesrvAddr</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerConfig</span>.<span style="color:#a6e22e">isFetchNamesrvAddrByAddressServer</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 这里支持从一个地址获取Namesrv的地址列表，就是通过Http#get从一个配置的网站地址获取，不再深入探讨</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">scheduledExecutorService</span>.<span style="color:#a6e22e">scheduleAtFixedRate</span>(<span style="color:#66d9ef">new</span> Runnable() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                        BrokerController.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">brokerOuterAPI</span>.<span style="color:#a6e22e">fetchNameServerAddr</span>();
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">catch</span> (Throwable e) {
</span></span><span style="display:flex;"><span>                        log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;ScheduledTask fetchNameServerAddr exception&#34;</span>, e);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }, 1000 <span style="color:#f92672">*</span> 10, 1000 <span style="color:#f92672">*</span> 60 <span style="color:#f92672">*</span> 2, TimeUnit.<span style="color:#a6e22e">MILLISECONDS</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 基于 Raft 协议的 commitlog 存储库 DLedger，可以参考 https://www.infoq.cn/article/7xeJrpDZBa9v*GDZOFS6</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 默认是不支持DLeger的，所以这里会进入到if里面，关于DLedger后面写到再研究吧</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>messageStoreConfig.<span style="color:#a6e22e">isEnableDLegerCommitLog</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果是SLAVE，根据条件判断是否周期的更新MasterHaServer的地址</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (BrokerRole.<span style="color:#a6e22e">SLAVE</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStoreConfig</span>.<span style="color:#a6e22e">getBrokerRole</span>()) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStoreConfig</span>.<span style="color:#a6e22e">getHaMasterAddress</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStoreConfig</span>.<span style="color:#a6e22e">getHaMasterAddress</span>().<span style="color:#a6e22e">length</span>() <span style="color:#f92672">&gt;=</span> 6) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStore</span>.<span style="color:#a6e22e">updateHaMasterAddress</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStoreConfig</span>.<span style="color:#a6e22e">getHaMasterAddress</span>());
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">updateMasterHAServerAddrPeriodically</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">updateMasterHAServerAddrPeriodically</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 如果不是SLAVE，周期性打印slave落后于master的diff</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">scheduledExecutorService</span>.<span style="color:#a6e22e">scheduleAtFixedRate</span>(<span style="color:#66d9ef">new</span> Runnable() {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                            BrokerController.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">printMasterAndSlaveDiff</span>();
</span></span><span style="display:flex;"><span>                        } <span style="color:#66d9ef">catch</span> (Throwable e) {
</span></span><span style="display:flex;"><span>                            log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;schedule printMasterAndSlaveDiff error.&#34;</span>, e);
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }, 1000 <span style="color:#f92672">*</span> 10, 1000 <span style="color:#f92672">*</span> 60, TimeUnit.<span style="color:#a6e22e">MILLISECONDS</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// TLS相关的忽略</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (TlsSystemConfig.<span style="color:#a6e22e">tlsMode</span> <span style="color:#f92672">!=</span> TlsMode.<span style="color:#a6e22e">DISABLED</span>) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 下面这三个方法又是RocketMQ的一些特性的组件初始化，通过方法名字就能知道组件和什么有关，这里不想详细分析，注意这里是通过SPI机制去初始化这3个组件的</span>
</span></span><span style="display:flex;"><span>        initialTransaction();
</span></span><span style="display:flex;"><span>        initialAcl();
</span></span><span style="display:flex;"><span>        initialRpcHooks();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>注册了Processor，NettyRemotingServer接收到Request时，对根据请求的类型查找Processor，让查找的Processor来处理这些请求，如果没找到对应的Processor，那么就会使用在NettyRemotingServer注册的DefaultProcessor来处理，不同的server注册的DefaultProcessor时不一样的，比如Broker注册的是AdminBrokerProcessor，Namesrv注册的是DefaultRequestProcessor</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerProcessor</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * SendMessageProcessor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    SendMessageProcessor sendProcessor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SendMessageProcessor(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    sendProcessor.<span style="color:#a6e22e">registerSendMessageHook</span>(sendMessageHookList);
</span></span><span style="display:flex;"><span>    sendProcessor.<span style="color:#a6e22e">registerConsumeMessageHook</span>(consumeMessageHookList);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">SEND_MESSAGE</span>, sendProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sendMessageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">SEND_MESSAGE_V2</span>, sendProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sendMessageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">SEND_BATCH_MESSAGE</span>, sendProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sendMessageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">CONSUMER_SEND_MSG_BACK</span>, sendProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sendMessageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">SEND_MESSAGE</span>, sendProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sendMessageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">SEND_MESSAGE_V2</span>, sendProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sendMessageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">SEND_BATCH_MESSAGE</span>, sendProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sendMessageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">CONSUMER_SEND_MSG_BACK</span>, sendProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sendMessageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * PullMessageProcessor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">PULL_MESSAGE</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pullMessageProcessor</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pullMessageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pullMessageProcessor</span>.<span style="color:#a6e22e">registerConsumeMessageHook</span>(consumeMessageHookList);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * QueryMessageProcessor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    NettyRequestProcessor queryProcessor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> QueryMessageProcessor(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">QUERY_MESSAGE</span>, queryProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">queryMessageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">VIEW_MESSAGE_BY_ID</span>, queryProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">queryMessageExecutor</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">QUERY_MESSAGE</span>, queryProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">queryMessageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">VIEW_MESSAGE_BY_ID</span>, queryProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">queryMessageExecutor</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * ClientManageProcessor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    ClientManageProcessor clientProcessor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClientManageProcessor(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">HEART_BEAT</span>, clientProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">heartbeatExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">UNREGISTER_CLIENT</span>, clientProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientManageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">CHECK_CLIENT_CONFIG</span>, clientProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientManageExecutor</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">HEART_BEAT</span>, clientProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">heartbeatExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">UNREGISTER_CLIENT</span>, clientProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientManageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">CHECK_CLIENT_CONFIG</span>, clientProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientManageExecutor</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * ConsumerManageProcessor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    ConsumerManageProcessor consumerManageProcessor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsumerManageProcessor(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">GET_CONSUMER_LIST_BY_GROUP</span>, consumerManageProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerManageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">UPDATE_CONSUMER_OFFSET</span>, consumerManageProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerManageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">QUERY_CONSUMER_OFFSET</span>, consumerManageProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerManageExecutor</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">GET_CONSUMER_LIST_BY_GROUP</span>, consumerManageProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerManageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">UPDATE_CONSUMER_OFFSET</span>, consumerManageProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerManageExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">QUERY_CONSUMER_OFFSET</span>, consumerManageProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumerManageExecutor</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * EndTransactionProcessor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">END_TRANSACTION</span>, <span style="color:#66d9ef">new</span> EndTransactionProcessor(<span style="color:#66d9ef">this</span>), <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">endTransactionExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">registerProcessor</span>(RequestCode.<span style="color:#a6e22e">END_TRANSACTION</span>, <span style="color:#66d9ef">new</span> EndTransactionProcessor(<span style="color:#66d9ef">this</span>), <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">endTransactionExecutor</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Default
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    AdminBrokerProcessor adminProcessor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AdminBrokerProcessor(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">registerDefaultProcessor</span>(adminProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">adminBrokerExecutor</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">registerDefaultProcessor</span>(adminProcessor, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">adminBrokerExecutor</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>再看看AdminBrokerProcessor中可以处理那些类型的请求</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> RemotingCommand <span style="color:#a6e22e">processRequest</span>(ChannelHandlerContext ctx,
</span></span><span style="display:flex;"><span>    RemotingCommand request) <span style="color:#66d9ef">throws</span> RemotingCommandException {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (request.<span style="color:#a6e22e">getCode</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">UPDATE_AND_CREATE_TOPIC</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">updateAndCreateTopic</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">DELETE_TOPIC_IN_BROKER</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">deleteTopic</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_ALL_TOPIC_CONFIG</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getAllTopicConfig</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">UPDATE_BROKER_CONFIG</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">updateBrokerConfig</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_BROKER_CONFIG</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getBrokerConfig</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">SEARCH_OFFSET_BY_TIMESTAMP</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">searchOffsetByTimestamp</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_MAX_OFFSET</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getMaxOffset</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_MIN_OFFSET</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getMinOffset</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_EARLIEST_MSG_STORETIME</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getEarliestMsgStoretime</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_BROKER_RUNTIME_INFO</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getBrokerRuntimeInfo</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">LOCK_BATCH_MQ</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">lockBatchMQ</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">UNLOCK_BATCH_MQ</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">unlockBatchMQ</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">UPDATE_AND_CREATE_SUBSCRIPTIONGROUP</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">updateAndCreateSubscriptionGroup</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_ALL_SUBSCRIPTIONGROUP_CONFIG</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getAllSubscriptionGroup</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">DELETE_SUBSCRIPTIONGROUP</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">deleteSubscriptionGroup</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_TOPIC_STATS_INFO</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getTopicStatsInfo</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_CONSUMER_CONNECTION_LIST</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getConsumerConnectionList</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_PRODUCER_CONNECTION_LIST</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getProducerConnectionList</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_CONSUME_STATS</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getConsumeStats</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_ALL_CONSUMER_OFFSET</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getAllConsumerOffset</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_ALL_DELAY_OFFSET</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getAllDelayOffset</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">INVOKE_BROKER_TO_RESET_OFFSET</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">resetOffset</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">INVOKE_BROKER_TO_GET_CONSUMER_STATUS</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getConsumerStatus</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">QUERY_TOPIC_CONSUME_BY_WHO</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">queryTopicConsumeByWho</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">REGISTER_FILTER_SERVER</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">registerFilterServer</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">QUERY_CONSUME_TIME_SPAN</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">queryConsumeTimeSpan</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_SYSTEM_TOPIC_LIST_FROM_BROKER</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getSystemTopicListFromBroker</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">CLEAN_EXPIRED_CONSUMEQUEUE</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">cleanExpiredConsumeQueue</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">CLEAN_UNUSED_TOPIC</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">cleanUnusedTopic</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_CONSUMER_RUNNING_INFO</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getConsumerRunningInfo</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">QUERY_CORRECTION_OFFSET</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">queryCorrectionOffset</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">CONSUME_MESSAGE_DIRECTLY</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">consumeMessageDirectly</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">CLONE_GROUP_OFFSET</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">cloneGroupOffset</span>(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">VIEW_BROKER_STATS_DATA</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ViewBrokerStatsData(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_BROKER_CONSUME_STATS</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> fetchAllConsumeStatsInBroker(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">QUERY_CONSUME_QUEUE</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> queryConsumeQueue(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">UPDATE_AND_CREATE_ACL_CONFIG</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> updateAndCreateAccessConfig(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">DELETE_ACL_CONFIG</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#960050;background-color:#1e0010">d</span>eleteAccessConfig(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">GET_BROKER_CLUSTER_ACL_INFO</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> getBrokerAclConfigVersion(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">UPDATE_GLOBAL_WHITE_ADDRS_CONFIG</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> updateGlobalWhiteAddrsConfig(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RequestCode.<span style="color:#a6e22e">RESUME_CHECK_HALF_MESSAGE</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> resumeCheckHalfMessage(ctx, request);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>registerProcessor和AdminBrokerProcessor就可以知道Broker可以接受哪些类型的请求了</p>
<p>到这里BrokerController#initialize()方法就算结束了，接下来就是执行BrokerController#start()方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStore</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">messageStore</span>.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">remotingServer</span>.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fastRemotingServer</span>.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fileWatchService</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fileWatchService</span>.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerOuterAPI</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerOuterAPI</span>.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pullRequestHoldService</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pullRequestHoldService</span>.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientHousekeepingService</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientHousekeepingService</span>.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">filterServerManager</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">filterServerManager</span>.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>messageStoreConfig.<span style="color:#a6e22e">isEnableDLegerCommitLog</span>()) {
</span></span><span style="display:flex;"><span>        startProcessorByHa(messageStoreConfig.<span style="color:#a6e22e">getBrokerRole</span>());
</span></span><span style="display:flex;"><span>        handleSlaveSynchronize(messageStoreConfig.<span style="color:#a6e22e">getBrokerRole</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 向Namesrv注册Broker，并且周期的向amesrv注册</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">registerBrokerAll</span>(<span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">scheduledExecutorService</span>.<span style="color:#a6e22e">scheduleAtFixedRate</span>(<span style="color:#66d9ef">new</span> Runnable() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                BrokerController.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">registerBrokerAll</span>(<span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>, brokerConfig.<span style="color:#a6e22e">isForceRegister</span>());
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Throwable e) {
</span></span><span style="display:flex;"><span>                log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;registerBrokerAll Exception&#34;</span>, e);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }, 1000 <span style="color:#f92672">*</span> 10, Math.<span style="color:#a6e22e">max</span>(10000, Math.<span style="color:#a6e22e">min</span>(brokerConfig.<span style="color:#a6e22e">getRegisterNameServerPeriod</span>(), 60000)), TimeUnit.<span style="color:#a6e22e">MILLISECONDS</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerStatsManager</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerStatsManager</span>.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerFastFailure</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">brokerFastFailure</span>.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到start()方法其实就是调用Broker中各种service和manager的start()方法，并且向Namesrv周期性的注册自己</p>
<p>到这里，Broker启动的流程基本就完了，但是还有很多坑没有填，因为Broker涉及到的组件比较多，接下来会分一系列文章来分析，这里只是从整体上理解Broker启动的流程</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="//localhost:1313/tags/rocketmq/">RocketMQ</a></li>
      <li><a href="//localhost:1313/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="//localhost:1313/">PaperMod</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
