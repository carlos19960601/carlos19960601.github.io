<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>各种你懂的协议 | Carlos的废话集</title>
<meta name="keywords" content="">
<meta name="description" content="Socks5协议 具体协议过程参考理解socks5协议的工作过程和协议细节。这篇文章主要是通过代码去理解socks5协议。
实验条件介绍 命令行设置proxy
export https_proxy=socks5://127.0.0.1:7891 http_proxy=socks5://127.0.0.1:7891 之后通过curl发起http请求。
curl www.baidu.com 这时候，curl这个命令就会走socks协议，并封装socks协议数据发送给socks5://127.0.0.1:7891。
协商阶段 根据参考资料，握手阶段-协商阶段发送的数据格式如下：
&#43;----&#43;----------&#43;----------&#43; |VER | NMETHODS | METHODS | &#43;----&#43;----------&#43;----------&#43; | 1 | 1 | 1 to 255 | &#43;----&#43;----------&#43;----------&#43; #上方的数字表示字节数，下面的表格同理，不再赘述 VER: 协议版本，socks5为0x05
NMETHODS: 支持认证的方法数量
METHODS: 对应NMETHODS，NMETHODS的值为多少，METHODS就有多少个字节。RFC预定义了一些值的含义，内容如下:
X’00’ NO AUTHENTICATION REQUIRED X’01’ GSSAPI X’02’ USERNAME/PASSWORD X’03’ to X’7F’ IANA ASSIGNED X’80’ to X’FE’ RESERVED FOR PRIVATE METHODS X’FF’ NO ACCEPTABLE METHODS 那么socks服务端接受到请求时，需要解析内容，选中一个METHOD返回给客户端，格式如下:
&#43;----&#43;--------&#43; |VER | METHOD | &#43;----&#43;--------&#43; | 1 | 1 | &#43;----&#43;--------&#43; func ServerHandshake(rw net.">
<meta name="author" content="">
<link rel="canonical" href="https://carlos19960601.github.io/posts/%E5%90%84%E7%A7%8D%E4%BD%A0%E6%87%82%E7%9A%84%E5%8D%8F%E8%AE%AE/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://carlos19960601.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://carlos19960601.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://carlos19960601.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://carlos19960601.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://carlos19960601.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://carlos19960601.github.io/posts/%E5%90%84%E7%A7%8D%E4%BD%A0%E6%87%82%E7%9A%84%E5%8D%8F%E8%AE%AE/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:title" content="各种你懂的协议" />
<meta property="og:description" content="Socks5协议 具体协议过程参考理解socks5协议的工作过程和协议细节。这篇文章主要是通过代码去理解socks5协议。
实验条件介绍 命令行设置proxy
export https_proxy=socks5://127.0.0.1:7891 http_proxy=socks5://127.0.0.1:7891 之后通过curl发起http请求。
curl www.baidu.com 这时候，curl这个命令就会走socks协议，并封装socks协议数据发送给socks5://127.0.0.1:7891。
协商阶段 根据参考资料，握手阶段-协商阶段发送的数据格式如下：
&#43;----&#43;----------&#43;----------&#43; |VER | NMETHODS | METHODS | &#43;----&#43;----------&#43;----------&#43; | 1 | 1 | 1 to 255 | &#43;----&#43;----------&#43;----------&#43; #上方的数字表示字节数，下面的表格同理，不再赘述 VER: 协议版本，socks5为0x05
NMETHODS: 支持认证的方法数量
METHODS: 对应NMETHODS，NMETHODS的值为多少，METHODS就有多少个字节。RFC预定义了一些值的含义，内容如下:
X’00’ NO AUTHENTICATION REQUIRED X’01’ GSSAPI X’02’ USERNAME/PASSWORD X’03’ to X’7F’ IANA ASSIGNED X’80’ to X’FE’ RESERVED FOR PRIVATE METHODS X’FF’ NO ACCEPTABLE METHODS 那么socks服务端接受到请求时，需要解析内容，选中一个METHOD返回给客户端，格式如下:
&#43;----&#43;--------&#43; |VER | METHOD | &#43;----&#43;--------&#43; | 1 | 1 | &#43;----&#43;--------&#43; func ServerHandshake(rw net." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://carlos19960601.github.io/posts/%E5%90%84%E7%A7%8D%E4%BD%A0%E6%87%82%E7%9A%84%E5%8D%8F%E8%AE%AE/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-07-07T09:01:39+08:00" />
<meta property="article:modified_time" content="2024-07-07T09:01:39+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="各种你懂的协议"/>
<meta name="twitter:description" content="Socks5协议 具体协议过程参考理解socks5协议的工作过程和协议细节。这篇文章主要是通过代码去理解socks5协议。
实验条件介绍 命令行设置proxy
export https_proxy=socks5://127.0.0.1:7891 http_proxy=socks5://127.0.0.1:7891 之后通过curl发起http请求。
curl www.baidu.com 这时候，curl这个命令就会走socks协议，并封装socks协议数据发送给socks5://127.0.0.1:7891。
协商阶段 根据参考资料，握手阶段-协商阶段发送的数据格式如下：
&#43;----&#43;----------&#43;----------&#43; |VER | NMETHODS | METHODS | &#43;----&#43;----------&#43;----------&#43; | 1 | 1 | 1 to 255 | &#43;----&#43;----------&#43;----------&#43; #上方的数字表示字节数，下面的表格同理，不再赘述 VER: 协议版本，socks5为0x05
NMETHODS: 支持认证的方法数量
METHODS: 对应NMETHODS，NMETHODS的值为多少，METHODS就有多少个字节。RFC预定义了一些值的含义，内容如下:
X’00’ NO AUTHENTICATION REQUIRED X’01’ GSSAPI X’02’ USERNAME/PASSWORD X’03’ to X’7F’ IANA ASSIGNED X’80’ to X’FE’ RESERVED FOR PRIVATE METHODS X’FF’ NO ACCEPTABLE METHODS 那么socks服务端接受到请求时，需要解析内容，选中一个METHOD返回给客户端，格式如下:
&#43;----&#43;--------&#43; |VER | METHOD | &#43;----&#43;--------&#43; | 1 | 1 | &#43;----&#43;--------&#43; func ServerHandshake(rw net."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://carlos19960601.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "各种你懂的协议",
      "item": "https://carlos19960601.github.io/posts/%E5%90%84%E7%A7%8D%E4%BD%A0%E6%87%82%E7%9A%84%E5%8D%8F%E8%AE%AE/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "各种你懂的协议",
  "name": "各种你懂的协议",
  "description": "Socks5协议 具体协议过程参考理解socks5协议的工作过程和协议细节。这篇文章主要是通过代码去理解socks5协议。\n实验条件介绍 命令行设置proxy\nexport https_proxy=socks5://127.0.0.1:7891 http_proxy=socks5://127.0.0.1:7891 之后通过curl发起http请求。\ncurl www.baidu.com 这时候，curl这个命令就会走socks协议，并封装socks协议数据发送给socks5://127.0.0.1:7891。\n协商阶段 根据参考资料，握手阶段-协商阶段发送的数据格式如下：\n+----+----------+----------+ |VER | NMETHODS | METHODS | +----+----------+----------+ | 1 | 1 | 1 to 255 | +----+----------+----------+ #上方的数字表示字节数，下面的表格同理，不再赘述 VER: 协议版本，socks5为0x05\nNMETHODS: 支持认证的方法数量\nMETHODS: 对应NMETHODS，NMETHODS的值为多少，METHODS就有多少个字节。RFC预定义了一些值的含义，内容如下:\nX’00’ NO AUTHENTICATION REQUIRED X’01’ GSSAPI X’02’ USERNAME/PASSWORD X’03’ to X’7F’ IANA ASSIGNED X’80’ to X’FE’ RESERVED FOR PRIVATE METHODS X’FF’ NO ACCEPTABLE METHODS 那么socks服务端接受到请求时，需要解析内容，选中一个METHOD返回给客户端，格式如下:\n+----+--------+ |VER | METHOD | +----+--------+ | 1 | 1 | +----+--------+ func ServerHandshake(rw net.",
  "keywords": [
    
  ],
  "articleBody": "Socks5协议 具体协议过程参考理解socks5协议的工作过程和协议细节。这篇文章主要是通过代码去理解socks5协议。\n实验条件介绍 命令行设置proxy\nexport https_proxy=socks5://127.0.0.1:7891 http_proxy=socks5://127.0.0.1:7891 之后通过curl发起http请求。\ncurl www.baidu.com 这时候，curl这个命令就会走socks协议，并封装socks协议数据发送给socks5://127.0.0.1:7891。\n协商阶段 根据参考资料，握手阶段-协商阶段发送的数据格式如下：\n+----+----------+----------+ |VER | NMETHODS | METHODS | +----+----------+----------+ | 1 | 1 | 1 to 255 | +----+----------+----------+ #上方的数字表示字节数，下面的表格同理，不再赘述 VER: 协议版本，socks5为0x05\nNMETHODS: 支持认证的方法数量\nMETHODS: 对应NMETHODS，NMETHODS的值为多少，METHODS就有多少个字节。RFC预定义了一些值的含义，内容如下:\nX’00’ NO AUTHENTICATION REQUIRED X’01’ GSSAPI X’02’ USERNAME/PASSWORD X’03’ to X’7F’ IANA ASSIGNED X’80’ to X’FE’ RESERVED FOR PRIVATE METHODS X’FF’ NO ACCEPTABLE METHODS 那么socks服务端接受到请求时，需要解析内容，选中一个METHOD返回给客户端，格式如下:\n+----+--------+ |VER | METHOD | +----+--------+ | 1 | 1 | +----+--------+ func ServerHandshake(rw net.Conn, authenticator auth.Authenticator) (addr Addr, command Command, user string, err error) { ... if _, err = io.ReadFull(rw, buf[:2]); err != nil { return } nmethods := buf[1] if _, err = io.ReadFull(rw, buf[:nmethods]); err != nil { return } // 返回信息,需要认证 if authenticator != nil { // 版本和认证方法 if _, err = rw.Write([]byte{5, 2}); err != nil { return } } ... } 上面代码逻辑就是处理这个过程。代码中固定返回的是X’02’ USERNAME/PASSWORD这种认证方式。\n认证阶段 认证阶段是一个可选的阶段，如果不需要认证，可以直接跳过。\n如果需要认证，客户端向socks5服务器发起一个认证请求，这里以0x02的认证方式举例:\n|VER | ULEN | UNAME | PLEN | PASSWD | +----+------+----------+------+----------+ | 1 | 1 | 1 to 255 | 1 | 1 to 255 | +----+------+----------+------+----------+ VER: 版本，**通常为`0x01`** ULEN: 用户名长度 UNAME: 对应用户名的字节数据 PLEN: 密码长度 PASSWD: 密码对应的数据 socks5服务器收到客户端的认证请求后，解析内容，验证信息是否合法，然后给客户端响应结果。响应格式如下:\n+----+--------+ |VER | STATUS | +----+--------+ | 1 | 1 | +----+--------+ 注意这里的VER并不少socks的版本\nfunc ServerHandshake(rw net.Conn, authenticator auth.Authenticator) (addr Addr, command Command, user string, err error) { ... // 返回信息,需要认证 if authenticator != nil { // 版本和认证方法 if _, err = rw.Write([]byte{5, 2}); err != nil { return } // 认证阶段 header := make([]byte, 2) if _, err = io.ReadFull(rw, header); err != nil { return } authBuf := make([]byte, MaxAuthLen) // 读取username userLen := int(header[1]) if userLen \u003c= 0 { // 返回认证失败 rw.Write([]byte{1, 1}) err = ErrAuth return } if _, err = io.ReadFull(rw, authBuf[:userLen]); err != nil { return } user = string(authBuf[:userLen]) // 读取pass if _, err = rw.Read(header[:1]); err != nil { return } passLen := int(header[0]) if passLen \u003c= 0 { // 返回认证失败 rw.Write([]byte{1, 1}) err = ErrAuth return } if _, err = io.ReadFull(rw, authBuf[:userLen]); err != nil { return } pass := string(authBuf[:userLen]) if ok := authenticator.Verify(user, pass); !ok { // 返回认证失败 rw.Write([]byte{1, 1}) err = ErrAuth return } // 返回认成功 if _, err = rw.Write([]byte{1, 0}); err != nil { return } } else { // 告诉客户端不需要验证 if _, err = rw.Write([]byte{5, 0}); err != nil { return } } return } ... 请求阶段 顺利通过协商阶段后，客户端向socks5服务器发起请求细节，格式如下:\n+----+-----+-------+------+----------+----------+ |VER | CMD | RSV | ATYP | DST.ADDR | DST.PORT | +----+-----+-------+------+----------+----------+ | 1 | 1 | X'00' | 1 | Variable | 2 | +----+-----+-------+------+----------+----------+ VER 版本号，socks5的值为0x05 CMD 0x01表示CONNECT请求 0x02表示BIND请求 0x03表示UDP转发 RSV 保留字段，值为0x00 ATYP 目标地址类型，DST.ADDR的数据对应这个字段的类型。 0x01表示IPv4地址，DST.ADDR为4个字节 0x03表示域名，DST.ADDR是一个可变长度的域名 0x04表示IPv6地址，DST.ADDR为16个字节长度 DST.ADDR 一个可变长度的值 DST.PORT 目标端口，固定2个字节 上面的值中，DST.ADDR是一个变长的数据，它的数据长度根据ATYP的类型决定。分为下面3种情况:\nX’01’ 一个4字节的ipv4地址 X’03’ 一个可变长度的域名，这种情况下DST.ADDR的第一个字节表示域名长度，剩下部分是域名内容。 X’04’ 一个16字节的ipv6地址 socks5服务器收到客户端的请求后，需要返回一个响应，结构如下\n+----+-----+-------+------+----------+----------+ |VER | REP | RSV | ATYP | BND.ADDR | BND.PORT | +----+-----+-------+------+----------+----------+ | 1 | 1 | X'00' | 1 | Variable | 2 | +----+-----+-------+------+----------+----------+ VER socks版本，这里为0x05 REP Relay field,内容取值如下 X’00’ succeeded X’01’ general SOCKS server failure X’02’ connection not allowed by ruleset X’03’ Network unreachable X’04’ Host unreachable X’05’ Connection refused X’06’ TTL expired X’07’ Command not supported X’08’ Address type not supported X’09’ to X’FF’ unassigned RSV 保留字段 ATYPE 同请求的ATYPE BND.ADDR 服务绑定的地址 BND.PORT 服务绑定的端口DST.PORT // 请求阶段 if _, err = io.ReadFull(rw, buf[:3]); err != nil { return } command = buf[1] addr, err = ReadAddr(rw, buf) if err != nil { return } switch command { case CmdConnect, CmdUDPAssociate: localAddr := ParseAddr(rw.LocalAddr().String()) if localAddr == nil { err = ErrAddressNotSupported } else { // 返回响应 _, err = rw.Write(bytes.Join([][]byte{{5, 0, 0}, localAddr}, []byte{})) } ... } func ReadAddr(r io.Reader, b []byte) (Addr, error) { _, err := io.ReadFull(r, b[:1]) if err != nil { return nil, err } switch b[0] { case AtypDomainName: _, err = io.ReadFull(r, b[1:2]) if err != nil { return nil, err } domainLength := uint16(b[1]) _, err = io.ReadFull(r, b[2:2+domainLength+2]) return b[:1+1+domainLength+2], err case AtypIPv4: _, err = io.ReadFull(r, b[1:1+net.IPv4len+2]) return b[:1+net.IPv4len+2], err case AtypIPv6: _, err = io.ReadFull(r, b[1:1+net.IPv6len+2]) return b[:1+net.IPv6len+2], err } return nil, ErrAddressNotSupported } Relay阶段 socks5服务器收到请求后，解析内容。如果是UDP请求，服务器直接转发; 如果是TCP请求，服务器向目标服务器建立TCP连接，后续负责把客户端的所有数据转发到目标服务。\nTrojan协议 连接Trojan服务端需要TLS握手，后续的流量就是TLS保护的了。\n参考资料 理解socks5协议的工作过程和协议细节 SOCKS Protocol Version 5 socks4.protocol The Trojan Protocol 浅析trojan协议原理 HTTPS 的工作原理 ",
  "wordCount" : "676",
  "inLanguage": "zh",
  "datePublished": "2024-07-07T09:01:39+08:00",
  "dateModified": "2024-07-07T09:01:39+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://carlos19960601.github.io/posts/%E5%90%84%E7%A7%8D%E4%BD%A0%E6%87%82%E7%9A%84%E5%8D%8F%E8%AE%AE/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Carlos的废话集",
    "logo": {
      "@type": "ImageObject",
      "url": "https://carlos19960601.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://carlos19960601.github.io/" accesskey="h" title="Carlos的废话集 (Alt + H)">Carlos的废话集</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://carlos19960601.github.io/archives" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://carlos19960601.github.io/tags" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://carlos19960601.github.io/search" title="搜索">
                    <span>搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      各种你懂的协议
    </h1>
    <div class="post-meta"><span title='2024-07-07 09:01:39 +0800 +0800'>2024-07-07</span>&nbsp;·&nbsp;4 分钟

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#socks5%e5%8d%8f%e8%ae%ae" aria-label="Socks5协议">Socks5协议</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e9%aa%8c%e6%9d%a1%e4%bb%b6%e4%bb%8b%e7%bb%8d" aria-label="实验条件介绍">实验条件介绍</a></li>
                <li>
                    <a href="#%e5%8d%8f%e5%95%86%e9%98%b6%e6%ae%b5" aria-label="协商阶段">协商阶段</a></li>
                <li>
                    <a href="#%e8%ae%a4%e8%af%81%e9%98%b6%e6%ae%b5" aria-label="认证阶段">认证阶段</a></li>
                <li>
                    <a href="#%e8%af%b7%e6%b1%82%e9%98%b6%e6%ae%b5" aria-label="请求阶段">请求阶段</a></li>
                <li>
                    <a href="#relay%e9%98%b6%e6%ae%b5" aria-label="Relay阶段">Relay阶段</a></li></ul>
                </li>
                <li>
                    <a href="#trojan%e5%8d%8f%e8%ae%ae" aria-label="Trojan协议">Trojan协议</a></li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" aria-label="参考资料">参考资料</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="socks5协议">Socks5协议<a hidden class="anchor" aria-hidden="true" href="#socks5协议">#</a></h1>
<p>具体协议过程参考<a href="https://wiyi.org/socks5-protocol-in-deep.html#25-%E5%8D%8F%E8%AE%AE%E7%BB%86%E8%8A%82">理解socks5协议的工作过程和协议细节</a>。这篇文章主要是通过代码去理解socks5协议。</p>
<h2 id="实验条件介绍">实验条件介绍<a hidden class="anchor" aria-hidden="true" href="#实验条件介绍">#</a></h2>
<p>命令行设置proxy</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>export https_proxy<span style="color:#f92672">=</span>socks5://127.0.0.1:7891 http_proxy<span style="color:#f92672">=</span>socks5://127.0.0.1:7891
</span></span></code></pre></div><p>之后通过curl发起http请求。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl www.baidu.com
</span></span></code></pre></div><p>这时候，curl这个命令就会走socks协议，并封装socks协议数据发送给<code>socks5://127.0.0.1:7891</code>。</p>
<h2 id="协商阶段">协商阶段<a hidden class="anchor" aria-hidden="true" href="#协商阶段">#</a></h2>
<p>根据参考资料，握手阶段-协商阶段发送的数据格式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>+----+----------+----------+
</span></span><span style="display:flex;"><span>|VER | NMETHODS | METHODS  |
</span></span><span style="display:flex;"><span>+----+----------+----------+
</span></span><span style="display:flex;"><span>| 1  |    1     | 1 to 255 |
</span></span><span style="display:flex;"><span>+----+----------+----------+
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#上方的数字表示字节数，下面的表格同理，不再赘述
</span></span></code></pre></div><p>VER: 协议版本，socks5为0x05</p>
<p>NMETHODS: 支持认证的方法数量</p>
<p>METHODS: 对应NMETHODS，NMETHODS的值为多少，METHODS就有多少个字节。RFC预定义了一些值的含义，内容如下:</p>
<ul>
<li>X’00’ NO AUTHENTICATION REQUIRED</li>
<li>X’01’ GSSAPI</li>
<li>X’02’ USERNAME/PASSWORD</li>
<li>X’03’ to X’7F’ IANA ASSIGNED</li>
<li>X’80’ to X’FE’ RESERVED FOR PRIVATE METHODS</li>
<li>X’FF’ NO ACCEPTABLE METHODS</li>
</ul>
<p>那么socks服务端接受到请求时，需要解析内容，选中一个METHOD返回给客户端，格式如下:</p>
<pre tabindex="0"><code>+----+--------+
|VER | METHOD |
+----+--------+
| 1  |   1    |
+----+--------+
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ServerHandshake</span>(<span style="color:#a6e22e">rw</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>, <span style="color:#a6e22e">authenticator</span> <span style="color:#a6e22e">auth</span>.<span style="color:#a6e22e">Authenticator</span>) (<span style="color:#a6e22e">addr</span> <span style="color:#a6e22e">Addr</span>, <span style="color:#a6e22e">command</span> <span style="color:#a6e22e">Command</span>, <span style="color:#a6e22e">user</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">rw</span>, <span style="color:#a6e22e">buf</span>[:<span style="color:#ae81ff">2</span>]); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">nmethods</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">buf</span>[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">rw</span>, <span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">nmethods</span>]); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 返回信息,需要认证
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">authenticator</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 版本和认证方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rw</span>.<span style="color:#a6e22e">Write</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">2</span>}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>上面代码逻辑就是处理这个过程。代码中固定返回的是<code>X’02’ USERNAME/PASSWORD</code>这种认证方式。</p>
<h2 id="认证阶段">认证阶段<a hidden class="anchor" aria-hidden="true" href="#认证阶段">#</a></h2>
<p>认证阶段是一个可选的阶段，如果不需要认证，可以直接跳过。</p>
<p>如果需要认证，客户端向socks5服务器发起一个认证请求，这里以<code>0x02</code>的认证方式举例:</p>
<pre tabindex="0"><code>|VER | ULEN |  UNAME   | PLEN |  PASSWD  |
+----+------+----------+------+----------+
| 1  |  1   | 1 to 255 |  1   | 1 to 255 |
+----+------+----------+------+----------+

VER: 版本，**通常为`0x01`**

ULEN: 用户名长度

UNAME: 对应用户名的字节数据

PLEN: 密码长度

PASSWD: 密码对应的数据
</code></pre><p>socks5服务器收到客户端的认证请求后，解析内容，验证信息是否合法，然后给客户端响应结果。响应格式如下:</p>
<pre tabindex="0"><code>+----+--------+
|VER | STATUS |
+----+--------+
| 1  |   1    |
+----+--------+
</code></pre><blockquote>
<p>注意这里的<code>VER</code>并不少socks的版本</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ServerHandshake</span>(<span style="color:#a6e22e">rw</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>, <span style="color:#a6e22e">authenticator</span> <span style="color:#a6e22e">auth</span>.<span style="color:#a6e22e">Authenticator</span>) (<span style="color:#a6e22e">addr</span> <span style="color:#a6e22e">Addr</span>, <span style="color:#a6e22e">command</span> <span style="color:#a6e22e">Command</span>, <span style="color:#a6e22e">user</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 返回信息,需要认证
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">authenticator</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 版本和认证方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rw</span>.<span style="color:#a6e22e">Write</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">2</span>}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 认证阶段
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">header</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">rw</span>, <span style="color:#a6e22e">header</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">authBuf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">MaxAuthLen</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 读取username
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">userLen</span> <span style="color:#f92672">:=</span> int(<span style="color:#a6e22e">header</span>[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">userLen</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 返回认证失败
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">rw</span>.<span style="color:#a6e22e">Write</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>})
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">ErrAuth</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">rw</span>, <span style="color:#a6e22e">authBuf</span>[:<span style="color:#a6e22e">userLen</span>]); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">user</span> = string(<span style="color:#a6e22e">authBuf</span>[:<span style="color:#a6e22e">userLen</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 读取pass
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rw</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">header</span>[:<span style="color:#ae81ff">1</span>]); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">passLen</span> <span style="color:#f92672">:=</span> int(<span style="color:#a6e22e">header</span>[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">passLen</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 返回认证失败
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">rw</span>.<span style="color:#a6e22e">Write</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>})
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">ErrAuth</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">rw</span>, <span style="color:#a6e22e">authBuf</span>[:<span style="color:#a6e22e">userLen</span>]); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">pass</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">authBuf</span>[:<span style="color:#a6e22e">userLen</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Verify</span>(<span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">pass</span>); !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 返回认证失败
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">rw</span>.<span style="color:#a6e22e">Write</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>})
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">ErrAuth</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 返回认成功
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rw</span>.<span style="color:#a6e22e">Write</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 告诉客户端不需要验证
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rw</span>.<span style="color:#a6e22e">Write</span>([]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span></code></pre></div><h2 id="请求阶段">请求阶段<a hidden class="anchor" aria-hidden="true" href="#请求阶段">#</a></h2>
<p>顺利通过协商阶段后，客户端向socks5服务器发起请求细节，格式如下:</p>
<pre tabindex="0"><code>+----+-----+-------+------+----------+----------+
|VER | CMD |  RSV  | ATYP | DST.ADDR | DST.PORT |
+----+-----+-------+------+----------+----------+
| 1  |  1  | X&#39;00&#39; |  1   | Variable |    2     |
+----+-----+-------+------+----------+----------+
</code></pre><ul>
<li>VER 版本号，socks5的值为0x05</li>
<li>CMD
<ul>
<li><code>0x01</code>表示CONNECT请求</li>
<li><code>0x02</code>表示BIND请求</li>
<li><code>0x03</code>表示UDP转发</li>
</ul>
</li>
<li>RSV 保留字段，值为0x00</li>
<li>ATYP 目标地址类型，DST.ADDR的数据对应这个字段的类型。
<ul>
<li><code>0x01</code>表示IPv4地址，DST.ADDR为4个字节</li>
<li><code>0x03</code>表示域名，DST.ADDR是一个可变长度的域名</li>
<li><code>0x04</code>表示IPv6地址，DST.ADDR为16个字节长度</li>
</ul>
</li>
<li>DST.ADDR 一个可变长度的值</li>
<li>DST.PORT 目标端口，固定2个字节</li>
</ul>
<p>上面的值中，DST.ADDR是一个变长的数据，它的数据长度根据ATYP的类型决定。分为下面3种情况:</p>
<ul>
<li>X’01’
<ul>
<li>一个4字节的ipv4地址</li>
</ul>
</li>
<li>X’03’
<ul>
<li>一个可变长度的域名，这种情况下DST.ADDR的第一个字节表示域名长度，剩下部分是域名内容。</li>
</ul>
</li>
<li>X’04’
<ul>
<li>一个16字节的ipv6地址</li>
</ul>
</li>
</ul>
<p>socks5服务器收到客户端的请求后，需要返回一个响应，结构如下</p>
<pre tabindex="0"><code>+----+-----+-------+------+----------+----------+
|VER | REP |  RSV  | ATYP | BND.ADDR | BND.PORT |
+----+-----+-------+------+----------+----------+
| 1  |  1  | X&#39;00&#39; |  1   | Variable |    2     |
+----+-----+-------+------+----------+----------+
</code></pre><ul>
<li>VER socks版本，这里为0x05</li>
<li>REP Relay field,内容取值如下</li>
<li>X’00’ succeeded
<ul>
<li>X’01’ general SOCKS server failure</li>
<li>X’02’ connection not allowed by ruleset</li>
<li>X’03’ Network unreachable</li>
<li>X’04’ Host unreachable</li>
<li>X’05’ Connection refused</li>
<li>X’06’ TTL expired</li>
<li>X’07’ Command not supported</li>
<li>X’08’ Address type not supported</li>
<li>X’09’ to X’FF’ unassigned</li>
</ul>
</li>
<li>RSV 保留字段</li>
<li>ATYPE 同请求的ATYPE</li>
<li>BND.ADDR 服务绑定的地址</li>
<li>BND.PORT 服务绑定的端口DST.PORT</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 请求阶段
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">rw</span>, <span style="color:#a6e22e">buf</span>[:<span style="color:#ae81ff">3</span>]); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">command</span> = <span style="color:#a6e22e">buf</span>[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">ReadAddr</span>(<span style="color:#a6e22e">rw</span>, <span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">command</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">CmdConnect</span>, <span style="color:#a6e22e">CmdUDPAssociate</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">localAddr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ParseAddr</span>(<span style="color:#a6e22e">rw</span>.<span style="color:#a6e22e">LocalAddr</span>().<span style="color:#a6e22e">String</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">localAddr</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">ErrAddressNotSupported</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 返回响应
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rw</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Join</span>([][]<span style="color:#66d9ef">byte</span>{{<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>}, <span style="color:#a6e22e">localAddr</span>}, []<span style="color:#66d9ef">byte</span>{}))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ReadAddr</span>(<span style="color:#a6e22e">r</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Reader</span>, <span style="color:#a6e22e">b</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#a6e22e">Addr</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">b</span>[:<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">0</span>] {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">AtypDomainName</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">domainLength</span> <span style="color:#f92672">:=</span> uint16(<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">2</span>:<span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#a6e22e">domainLength</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">b</span>[:<span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#a6e22e">domainLength</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>], <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">AtypIPv4</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">IPv4len</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">b</span>[:<span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">IPv4len</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>], <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">AtypIPv6</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">IPv6len</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">b</span>[:<span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">IPv6len</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>], <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ErrAddressNotSupported</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="relay阶段">Relay阶段<a hidden class="anchor" aria-hidden="true" href="#relay阶段">#</a></h2>
<p>socks5服务器收到请求后，解析内容。如果是UDP请求，服务器直接转发; 如果是TCP请求，服务器向目标服务器建立TCP连接，后续负责把客户端的所有数据转发到目标服务。</p>
<h1 id="trojan协议">Trojan协议<a hidden class="anchor" aria-hidden="true" href="#trojan协议">#</a></h1>
<p>连接<code>Trojan</code>服务端需要<code>TLS</code>握手，后续的流量就是<code>TLS</code>保护的了。</p>
<h1 id="参考资料">参考资料<a hidden class="anchor" aria-hidden="true" href="#参考资料">#</a></h1>
<ul>
<li><a href="https://wiyi.org/socks5-protocol-in-deep.html#25-%E5%8D%8F%E8%AE%AE%E7%BB%86%E8%8A%82">理解socks5协议的工作过程和协议细节</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc1928">SOCKS Protocol Version 5</a></li>
<li><a href="https://www.openssh.com/txt/socks4.protocol">socks4.protocol</a></li>
<li><a href="https://trojan-gfw.github.io/trojan/protocol">The Trojan Protocol</a></li>
<li><a href="https://ajian.one/2023/11/11/%E6%B5%85%E6%9E%90trojan%E5%8D%8F%E8%AE%AE%E5%8E%9F%E7%90%86/">浅析trojan协议原理</a></li>
<li><a href="https://howhttps.works/zh/">HTTPS 的工作原理</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://carlos19960601.github.io/posts/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/">
    <span class="title">« 上一页</span>
    <br>
    <span>线性代数</span>
  </a>
  <a class="next" href="https://carlos19960601.github.io/posts/%E6%96%B0%E6%9C%BA%E5%BF%85%E5%A4%87%E8%BD%AF%E4%BB%B6/">
    <span class="title">下一页 »</span>
    <br>
    <span>新机必备软件</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 各种你懂的协议 on x"
            href="https://x.com/intent/tweet/?text=%e5%90%84%e7%a7%8d%e4%bd%a0%e6%87%82%e7%9a%84%e5%8d%8f%e8%ae%ae&amp;url=https%3a%2f%2fcarlos19960601.github.io%2fposts%2f%25E5%2590%2584%25E7%25A7%258D%25E4%25BD%25A0%25E6%2587%2582%25E7%259A%2584%25E5%258D%258F%25E8%25AE%25AE%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 各种你懂的协议 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fcarlos19960601.github.io%2fposts%2f%25E5%2590%2584%25E7%25A7%258D%25E4%25BD%25A0%25E6%2587%2582%25E7%259A%2584%25E5%258D%258F%25E8%25AE%25AE%2f&amp;title=%e5%90%84%e7%a7%8d%e4%bd%a0%e6%87%82%e7%9a%84%e5%8d%8f%e8%ae%ae&amp;summary=%e5%90%84%e7%a7%8d%e4%bd%a0%e6%87%82%e7%9a%84%e5%8d%8f%e8%ae%ae&amp;source=https%3a%2f%2fcarlos19960601.github.io%2fposts%2f%25E5%2590%2584%25E7%25A7%258D%25E4%25BD%25A0%25E6%2587%2582%25E7%259A%2584%25E5%258D%258F%25E8%25AE%25AE%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 各种你懂的协议 on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fcarlos19960601.github.io%2fposts%2f%25E5%2590%2584%25E7%25A7%258D%25E4%25BD%25A0%25E6%2587%2582%25E7%259A%2584%25E5%258D%258F%25E8%25AE%25AE%2f&title=%e5%90%84%e7%a7%8d%e4%bd%a0%e6%87%82%e7%9a%84%e5%8d%8f%e8%ae%ae">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 各种你懂的协议 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcarlos19960601.github.io%2fposts%2f%25E5%2590%2584%25E7%25A7%258D%25E4%25BD%25A0%25E6%2587%2582%25E7%259A%2584%25E5%258D%258F%25E8%25AE%25AE%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 各种你懂的协议 on whatsapp"
            href="https://api.whatsapp.com/send?text=%e5%90%84%e7%a7%8d%e4%bd%a0%e6%87%82%e7%9a%84%e5%8d%8f%e8%ae%ae%20-%20https%3a%2f%2fcarlos19960601.github.io%2fposts%2f%25E5%2590%2584%25E7%25A7%258D%25E4%25BD%25A0%25E6%2587%2582%25E7%259A%2584%25E5%258D%258F%25E8%25AE%25AE%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 各种你懂的协议 on telegram"
            href="https://telegram.me/share/url?text=%e5%90%84%e7%a7%8d%e4%bd%a0%e6%87%82%e7%9a%84%e5%8d%8f%e8%ae%ae&amp;url=https%3a%2f%2fcarlos19960601.github.io%2fposts%2f%25E5%2590%2584%25E7%25A7%258D%25E4%25BD%25A0%25E6%2587%2582%25E7%259A%2584%25E5%258D%258F%25E8%25AE%25AE%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 各种你懂的协议 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=%e5%90%84%e7%a7%8d%e4%bd%a0%e6%87%82%e7%9a%84%e5%8d%8f%e8%ae%ae&u=https%3a%2f%2fcarlos19960601.github.io%2fposts%2f%25E5%2590%2584%25E7%25A7%258D%25E4%25BD%25A0%25E6%2587%2582%25E7%259A%2584%25E5%258D%258F%25E8%25AE%25AE%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://carlos19960601.github.io/">Carlos的废话集</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
